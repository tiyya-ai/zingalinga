#!/usr/bin/env node

/**
 * Zinga Linga Deployment Test Suite
 * ูุฌููุนุฉ ุงุฎุชุจุงุฑุงุช ุงููุดุฑ ูู Zinga Linga
 */

const { exec } = require('child_process');
const https = require('https');
const http = require('http');
const fs = require('fs');

class DeploymentTester {
  constructor() {
    this.config = {
      vps: {
        ip: '109.199.106.28',
        user: 'root',
        password: 'Secureweb25',
        port: 22
      },
      app: {
        name: 'zinga-linga',
        domain: 'zingalinga.io',
        localPort: 3000,
        deployPath: '/var/www/zinga-linga'
      }
    };
    
    this.tests = [];
    this.results = {
      passed: 0,
      failed: 0,
      total: 0
    };
  }

  async runAllTests() {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑุงุช ุงููุดุฑ ูู Zinga Linga');
    console.log('=====================================\n');

    // Local tests
    await this.testLocalBuild();
    await this.testLocalFiles();
    await this.testGitRepository();
    
    // VPS tests
    await this.testVPSConnection();
    await this.testVPSServices();
    await this.testApplicationStatus();
    
    // Web tests
    await this.testWebsiteAccess();
    await this.testAPIEndpoints();
    
    // GitHub Actions tests
    await this.testGitHubActionsSetup();
    
    this.displayResults();
  }

  async testLocalBuild() {
    await this.runTest('๐๏ธ ุงุฎุชุจุงุฑ ุงูุจูุงุก ุงููุญูู', async () => {
      // Check if .next directory exists
      if (!fs.existsSync('.next')) {
        throw new Error('ูุฌูุฏ .next ุบูุฑ ููุฌูุฏ - ูุฑุฌู ุชุดุบูู npm run build');
      }
      
      // Check if build ID exists
      if (!fs.existsSync('.next/BUILD_ID')) {
        throw new Error('BUILD_ID ุบูุฑ ููุฌูุฏ - ุงูุจูุงุก ุบูุฑ ููุชูู');
      }
      
      const buildId = fs.readFileSync('.next/BUILD_ID', 'utf8').trim();
      return `Build ID: ${buildId}`;
    });
  }

  async testLocalFiles() {
    await this.runTest('๐ ุงุฎุชุจุงุฑ ุงููููุงุช ุงููุทููุจุฉ', async () => {
      const requiredFiles = [
        'package.json',
        'next.config.js',
        '.github/workflows/deploy.yml',
        'vps-config.js'
      ];
      
      const missingFiles = requiredFiles.filter(file => !fs.existsSync(file));
      
      if (missingFiles.length > 0) {
        throw new Error(`ูููุงุช ููููุฏุฉ: ${missingFiles.join(', ')}`);
      }
      
      return `ุฌููุน ุงููููุงุช ุงููุทููุจุฉ ููุฌูุฏุฉ (${requiredFiles.length})`;
    });
  }

  async testGitRepository() {
    await this.runTest('๐ ุงุฎุชุจุงุฑ ูุณุชูุฏุน Git', async () => {
      return new Promise((resolve, reject) => {
        exec('git remote -v', (error, stdout, stderr) => {
          if (error) {
            reject(new Error('ูุณุชูุฏุน Git ุบูุฑ ููุนุฏ - ูุฑุฌู ุฑุจุท ุงููุดุฑูุน ุจู GitHub'));
            return;
          }
          
          if (!stdout.includes('github.com')) {
            reject(new Error('ูุง ููุฌุฏ remote GitHub - ูุฑุฌู ุฅุถุงูุฉ GitHub remote'));
            return;
          }
          
          resolve('ูุณุชูุฏุน GitHub ููุนุฏ ุจุดูู ุตุญูุญ');
        });
      });
    });
  }

  async testVPSConnection() {
    await this.runTest('๐ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจู VPS', async () => {
      return new Promise((resolve, reject) => {
        exec(`ping -c 1 ${this.config.vps.ip}`, (error, stdout, stderr) => {
          if (error) {
            reject(new Error('ูุง ูููู ุงููุตูู ุฅูู VPS - ุชุญูู ูู ุงูุงุชุตุงู'));
            return;
          }
          
          resolve(`VPS ูุชุงุญ (${this.config.vps.ip})`);
        });
      });
    });
  }

  async testVPSServices() {
    await this.runTest('๐ง ุงุฎุชุจุงุฑ ุฎุฏูุงุช VPS', async () => {
      return new Promise((resolve, reject) => {
        const sshCommand = `sshpass -p "${this.config.vps.password}" ssh -o StrictHostKeyChecking=no ${this.config.vps.user}@${this.config.vps.ip}`;
        
        exec(`${sshCommand} "systemctl is-active nginx && pm2 --version && node --version"`, (error, stdout, stderr) => {
          if (error) {
            reject(new Error('ุฎุฏูุงุช VPS ุบูุฑ ููุนุฏุฉ ุจุดูู ุตุญูุญ'));
            return;
          }
          
          const services = stdout.trim().split('\n');
          resolve(`NGINX: ${services[0]}, PM2: ${services[1]}, Node.js: ${services[2]}`);
        });
      });
    });
  }

  async testApplicationStatus() {
    await this.runTest('๐ ุงุฎุชุจุงุฑ ุญุงูุฉ ุงูุชุทุจูู', async () => {
      return new Promise((resolve, reject) => {
        const sshCommand = `sshpass -p "${this.config.vps.password}" ssh -o StrictHostKeyChecking=no ${this.config.vps.user}@${this.config.vps.ip}`;
        
        exec(`${sshCommand} "pm2 list | grep ${this.config.app.name}"`, (error, stdout, stderr) => {
          if (error || !stdout.includes(this.config.app.name)) {
            reject(new Error('ุงูุชุทุจูู ุบูุฑ ููุดุบู ุนูู PM2'));
            return;
          }
          
          if (stdout.includes('online')) {
            resolve('ุงูุชุทุจูู ูุนูู ุจุดูู ุตุญูุญ');
          } else {
            reject(new Error('ุงูุชุทุจูู ูุชููู ุฃู ููุงุฌู ูุดุงูู'));
          }
        });
      });
    });
  }

  async testWebsiteAccess() {
    await this.runTest('๐ ุงุฎุชุจุงุฑ ุงููุตูู ูููููุน', async () => {
      const urls = [
        `http://${this.config.app.domain}`,
        `http://${this.config.vps.ip}:${this.config.app.localPort}`,
        `http://${this.config.vps.ip}`
      ];

      const results = [];
      
      for (const url of urls) {
        try {
          const status = await this.checkURL(url);
          results.push(`${url}: ${status}`);
        } catch (error) {
          results.push(`${url}: ุฎุทุฃ`);
        }
      }
      
      return results.join(', ');
    });
  }

  async testAPIEndpoints() {
    await this.runTest('๐ ุงุฎุชุจุงุฑ API Endpoints', async () => {
      const endpoints = [
        '/api/data',
        '/api/health'
      ];
      
      const results = [];
      
      for (const endpoint of endpoints) {
        try {
          const url = `http://${this.config.app.domain}${endpoint}`;
          const status = await this.checkURL(url);
          results.push(`${endpoint}: ${status}`);
        } catch (error) {
          results.push(`${endpoint}: ุบูุฑ ูุชุงุญ`);
        }
      }
      
      return results.join(', ');
    });
  }

  async testGitHubActionsSetup() {
    await this.runTest('โ๏ธ ุงุฎุชุจุงุฑ ุฅุนุฏุงุฏ GitHub Actions', async () => {
      const workflowFile = '.github/workflows/deploy.yml';
      
      if (!fs.existsSync(workflowFile)) {
        throw new Error('ููู GitHub Actions ุบูุฑ ููุฌูุฏ');
      }
      
      const content = fs.readFileSync(workflowFile, 'utf8');
      
      const requiredSecrets = ['VPS_HOST', 'VPS_USER', 'VPS_SSH_KEY'];
      const missingSecrets = requiredSecrets.filter(secret => !content.includes(`secrets.${secret}`));
      
      if (missingSecrets.length > 0) {
        throw new Error(`GitHub Secrets ููููุฏุฉ: ${missingSecrets.join(', ')}`);
      }
      
      return 'GitHub Actions ููุนุฏ ุจุดูู ุตุญูุญ';
    });
  }

  async checkURL(url) {
    return new Promise((resolve, reject) => {
      const client = url.startsWith('https') ? https : http;
      const urlObj = new URL(url);
      
      const options = {
        hostname: urlObj.hostname,
        port: urlObj.port || (url.startsWith('https') ? 443 : 80),
        path: urlObj.pathname,
        method: 'GET',
        timeout: 5000
      };

      const req = client.request(options, (res) => {
        resolve(`${res.statusCode}`);
      });

      req.on('error', (error) => {
        reject(error);
      });

      req.on('timeout', () => {
        req.destroy();
        reject(new Error('Timeout'));
      });

      req.end();
    });
  }

  async runTest(name, testFunction) {
    this.results.total++;
    
    try {
      console.log(`๐ ${name}...`);
      const result = await testFunction();
      console.log(`โ ${name}: ${result}`);
      this.results.passed++;
    } catch (error) {
      console.log(`โ ${name}: ${error.message}`);
      this.results.failed++;
    }
    
    console.log('');
  }

  displayResults() {
    console.log('๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑุงุช');
    console.log('==================');
    console.log(`โ ูุฌุญ: ${this.results.passed}`);
    console.log(`โ ูุดู: ${this.results.failed}`);
    console.log(`๐ ุงููุฌููุน: ${this.results.total}`);
    
    const percentage = Math.round((this.results.passed / this.results.total) * 100);
    console.log(`๐ ูุนุฏู ุงููุฌุงุญ: ${percentage}%`);
    
    if (this.results.failed === 0) {
      console.log('\n๐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช! ุงููุดุฑ ุฌุงูุฒ.');
    } else {
      console.log('\n๏ฟฝ๏ฟฝ๏ธ ููุฌุฏ ูุดุงูู ุชุญุชุงุฌ ุฅูู ุญู ูุจู ุงููุดุฑ.');
    }
    
    console.log('\n๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:');
    if (this.results.failed > 0) {
      console.log('1. ุญู ุงููุดุงูู ุงููุฐููุฑุฉ ุฃุนูุงู');
      console.log('2. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช');
    } else {
      console.log('1. ุงุนูู commit ู push ููุชูุนูู ุงููุดุฑ ุงูุชููุงุฆู');
      console.log('2. ุฑุงูุจ GitHub Actions');
      console.log('3. ุชุญูู ูู ุงููููุน ุนูู http://zingalinga.io');
    }
  }

  async quickFix() {
    console.log('๐ง ูุญุงููุฉ ุฅุตูุงุญ ุณุฑูุน...\n');
    
    // Fix 1: Build if .next doesn't exist
    if (!fs.existsSync('.next')) {
      console.log('๐๏ธ ุจูุงุก ุงูุชุทุจูู...');
      await this.executeCommand('npm run build');
    }
    
    // Fix 2: Restart application on VPS
    console.log('๐ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู ุนูู VPS...');
    const sshCommand = `sshpass -p "${this.config.vps.password}" ssh -o StrictHostKeyChecking=no ${this.config.vps.user}@${this.config.vps.ip}`;
    await this.executeCommand(`${sshCommand} "pm2 restart ${this.config.app.name} && systemctl reload nginx"`);
    
    console.log('โ ุชู ุงูุฅุตูุงุญ ุงูุณุฑูุน');
  }

  async executeCommand(command) {
    return new Promise((resolve, reject) => {
      exec(command, (error, stdout, stderr) => {
        if (error) {
          console.log(`โ ุฎุทุฃ: ${error.message}`);
          reject(error);
        } else {
          console.log(`โ ุชู ุงูุชูููุฐ ุจูุฌุงุญ`);
          resolve(stdout);
        }
      });
    });
  }
}

// CLI Interface
if (require.main === module) {
  const tester = new DeploymentTester();
  const args = process.argv.slice(2);
  
  if (args.includes('--fix')) {
    tester.quickFix().catch(console.error);
  } else {
    tester.runAllTests().catch(console.error);
  }
}

module.exports = DeploymentTester;