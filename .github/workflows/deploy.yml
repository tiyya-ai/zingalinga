name: ğŸš€ Auto Deploy to VPS - Zinga Linga

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

jobs:
  deploy:
    name: ğŸŒ Deploy to Production VPS
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        echo "âœ… Dependencies installed successfully"

    - name: ğŸ—ï¸ Build Application
      run: |
        npm run build
        echo "âœ… Application built successfully"
        
    - name: ğŸ“‹ Verify Build
      run: |
        if [ -d ".next" ]; then
          echo "âœ… Build directory exists"
          ls -la .next/
        else
          echo "âŒ Build failed - .next directory not found"
          exit 1
        fi

    - name: ğŸ—œï¸ Create Deployment Package
      run: |
        echo "ğŸ“¦ Creating deployment package..."
        tar --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.log' \
            --exclude='deployment-progress.json' \
            -czf zinga-linga-deploy.tar.gz \
            .next package.json package-lock.json public src next.config.js tailwind.config.js postcss.config.js tsconfig.json
        echo "âœ… Deployment package created: $(ls -lh zinga-linga-deploy.tar.gz)"

    - name: ğŸ” Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        echo "âœ… SSH key configured"

    - name: â¬†ï¸ Upload to VPS
      run: |
        echo "ğŸ“¤ Uploading deployment package to VPS..."
        scp -i ~/.ssh/id_rsa zinga-linga-deploy.tar.gz ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/
        echo "âœ… Upload completed"

    - name: ğŸš€ Deploy on VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          
          echo "ğŸš€ Starting deployment process..."
          
          # Create backup of current deployment
          if [ -d "/var/www/zinga-linga" ]; then
            echo "ğŸ“‹ Creating backup..."
            sudo cp -r /var/www/zinga-linga /var/www/zinga-linga-backup-$(date +%Y%m%d-%H%M%S)
          fi
          
          # Create application directory
          echo "ğŸ“ Setting up application directory..."
          sudo mkdir -p /var/www/zinga-linga
          cd /var/www/zinga-linga
          
          # Stop current application
          echo "â¹ï¸ Stopping current application..."
          sudo pm2 stop zinga-linga || echo "Application not running"
          
          # Clear old files (keep node_modules for faster deployment)
          echo "ğŸ§¹ Cleaning old files..."
          sudo rm -rf .next public src package.json package-lock.json *.config.js tsconfig.json
          
          # Extract new deployment
          echo "ğŸ“¦ Extracting new deployment..."
          sudo tar -xzf /tmp/zinga-linga-deploy.tar.gz
          
          # Set proper permissions
          echo "ğŸ” Setting permissions..."
          sudo chown -R $USER:$USER /var/www/zinga-linga
          
          # Install/update dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production --no-audit --no-fund
          
          # Start application with PM2
          echo "ğŸš€ Starting application..."
          pm2 start npm --name "zinga-linga" -- start || pm2 restart zinga-linga
          pm2 save
          
          # Verify deployment
          echo "âœ… Verifying deployment..."
          sleep 5
          if pm2 list | grep -q "zinga-linga.*online"; then
            echo "âœ… Application is running successfully!"
          else
            echo "âŒ Application failed to start"
            pm2 logs zinga-linga --lines 20
            exit 1
          fi
          
          # Test application response
          echo "ğŸŒ Testing application response..."
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Application is responding correctly!"
          else
            echo "âš ï¸ Application may not be responding on port 3000"
          fi
          
          # Cleanup
          echo "ğŸ§¹ Cleaning up..."
          rm -f /tmp/zinga-linga-deploy.tar.gz
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Your application is available at: http://zingalinga.io"

    - name: ğŸ”„ Restart NGINX (if configured)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          if systemctl is-active --quiet nginx; then
            echo "ğŸ”„ Restarting NGINX..."
            sudo systemctl reload nginx
            echo "âœ… NGINX reloaded successfully"
          else
            echo "â„¹ï¸ NGINX is not running or not installed"
          fi

    - name: ğŸ“Š Deployment Summary
      run: |
        echo "## ğŸ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status**: Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "ğŸŒ **URL**: http://zingalinga.io" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‘¤ **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- Visit [zingalinga.io](http://zingalinga.io) to verify deployment" >> $GITHUB_STEP_SUMMARY
        echo "- Check application logs if needed: \`pm2 logs zinga-linga\`" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor application performance" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ Deployment to zingalinga.io completed successfully!"
        else
          echo "âŒ Deployment failed. Please check the logs."
        fi